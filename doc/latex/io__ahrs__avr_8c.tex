\hypertarget{io__ahrs__avr_8c}{}\section{src/ahrs/io\+\_\+ahrs\+\_\+avr.c File Reference}
\label{io__ahrs__avr_8c}\index{src/ahrs/io\+\_\+ahrs\+\_\+avr.\+c@{src/ahrs/io\+\_\+ahrs\+\_\+avr.\+c}}
{\ttfamily \#include $<$assert.\+h$>$}\newline
{\ttfamily \#include $<$avr/io.\+h$>$}\newline
{\ttfamily \#include $<$avr/interrupt.\+h$>$}\newline
{\ttfamily \#include $<$stdatomic.\+h$>$}\newline
{\ttfamily \#include \char`\"{}ahrs/io\+\_\+ahrs.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}macrodef.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}dbg.\+h\char`\"{}}\newline
{\ttfamily \#include $<$util/setbaud.\+h$>$}\newline
Include dependency graph for io\+\_\+ahrs\+\_\+avr.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{io__ahrs__avr_8c__incl}
\end{center}
\end{figure}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{io__ahrs__avr_8c_a45719155cbf4258c29211c2f5db49b9b}{N\+U\+S\+A\+RT}~2
\item 
\#define \hyperlink{io__ahrs__avr_8c_a62634036639f88eece6fbf226b45f84b}{B\+A\+UD}~38400\+UL
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
void \hyperlink{io__ahrs__avr_8c_a312fc51f6c9726e41cfbc780cfcfecdc}{io\+\_\+ahrs\+\_\+init} (char const $\ast$path)
\begin{DoxyCompactList}\small\item\em Prepare A\+H\+RS to receive data. \end{DoxyCompactList}\item 
void \hyperlink{io__ahrs__avr_8c_a9db69393e769bcdd5ddc9ec5f125d11d}{io\+\_\+ahrs\+\_\+clean} ()
\begin{DoxyCompactList}\small\item\em Disable A\+H\+RS transmit and receive. \end{DoxyCompactList}\item 
\hyperlink{io__ahrs__avr_8c_a41000847b03ed4695d02308472ac32e7}{I\+SR} (\hyperlink{io__m5__avr_8c_ad886765314d53f6e8cb3eeaac5bffda8}{C\+C\+\_\+\+X\+XX}(U\+S\+A\+RT, \hyperlink{io__m5__avr_8c_a45719155cbf4258c29211c2f5db49b9b}{N\+U\+S\+A\+RT}, \+\_\+\+R\+X\+\_\+vect))
\item 
int \hyperlink{io__ahrs__avr_8c_afa79bf757710a1cad094f1e15eb634b7}{io\+\_\+ahrs\+\_\+recv\+\_\+start} (int($\ast$handler)())
\begin{DoxyCompactList}\small\item\em Tells A\+H\+RS to start receiving attitude data. \end{DoxyCompactList}\item 
void \hyperlink{io__ahrs__avr_8c_a2ee2459ddd2dca694bef3e6fb9b1cd54}{io\+\_\+ahrs\+\_\+recv\+\_\+stop} ()
\begin{DoxyCompactList}\small\item\em Tells A\+H\+RS to start receiving attitude data. \end{DoxyCompactList}\item 
bool \hyperlink{io__ahrs__avr_8c_a7b33a09e7c9290bcdeebf2602a54ee3d}{io\+\_\+ahrs\+\_\+tripbuf\+\_\+update} ()
\begin{DoxyCompactList}\small\item\em Updates tripbuf with new data. \end{DoxyCompactList}\item 
void \hyperlink{io__ahrs__avr_8c_ac133fdc94162c623c5325f907ade9e4a}{io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer} ()
\begin{DoxyCompactList}\small\item\em Allows tripbuf to be updated again. (Might need Seth\textquotesingle{}s confirmation) \end{DoxyCompactList}\item 
unsigned char \hyperlink{io__ahrs__avr_8c_a7690920caf5d41a90442ca049336778c}{io\+\_\+ahrs\+\_\+tripbuf\+\_\+write} ()
\begin{DoxyCompactList}\small\item\em Finds tripbuf index to write to. \end{DoxyCompactList}\item 
unsigned char \hyperlink{io__ahrs__avr_8c_a7e158c735ff3b4a8b84cd5bd552c4954}{io\+\_\+ahrs\+\_\+tripbuf\+\_\+read} ()
\begin{DoxyCompactList}\small\item\em Finds tripbuf index to read from. \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
F\+I\+LE $\ast$ \hyperlink{io__ahrs__avr_8c_a7c946296e6bffe77d1c08cdcbd4def85}{io\+\_\+ahrs}
\begin{DoxyCompactList}\small\item\em Handles IO to A\+H\+RS using file streams. \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\mbox{\Hypertarget{io__ahrs__avr_8c_a62634036639f88eece6fbf226b45f84b}\label{io__ahrs__avr_8c_a62634036639f88eece6fbf226b45f84b}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!B\+A\+UD@{B\+A\+UD}}
\index{B\+A\+UD@{B\+A\+UD}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{B\+A\+UD}{BAUD}}
{\footnotesize\ttfamily \#define B\+A\+UD~38400\+UL}

\mbox{\Hypertarget{io__ahrs__avr_8c_a45719155cbf4258c29211c2f5db49b9b}\label{io__ahrs__avr_8c_a45719155cbf4258c29211c2f5db49b9b}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!N\+U\+S\+A\+RT@{N\+U\+S\+A\+RT}}
\index{N\+U\+S\+A\+RT@{N\+U\+S\+A\+RT}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{N\+U\+S\+A\+RT}{NUSART}}
{\footnotesize\ttfamily \#define N\+U\+S\+A\+RT~2}

atomic\+\_\+signal\+\_\+fence is used in some places to try to get memory synchronization with I\+S\+Rs 

\subsection{Function Documentation}
\mbox{\Hypertarget{io__ahrs__avr_8c_a9db69393e769bcdd5ddc9ec5f125d11d}\label{io__ahrs__avr_8c_a9db69393e769bcdd5ddc9ec5f125d11d}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs\+\_\+clean@{io\+\_\+ahrs\+\_\+clean}}
\index{io\+\_\+ahrs\+\_\+clean@{io\+\_\+ahrs\+\_\+clean}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs\+\_\+clean()}{io\_ahrs\_clean()}}
{\footnotesize\ttfamily void io\+\_\+ahrs\+\_\+clean (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Disable A\+H\+RS transmit and receive. 

Unimplemented. \mbox{\Hypertarget{io__ahrs__avr_8c_a312fc51f6c9726e41cfbc780cfcfecdc}\label{io__ahrs__avr_8c_a312fc51f6c9726e41cfbc780cfcfecdc}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs\+\_\+init@{io\+\_\+ahrs\+\_\+init}}
\index{io\+\_\+ahrs\+\_\+init@{io\+\_\+ahrs\+\_\+init}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs\+\_\+init()}{io\_ahrs\_init()}}
{\footnotesize\ttfamily void io\+\_\+ahrs\+\_\+init (\begin{DoxyParamCaption}\item[{char const $\ast$}]{path }\end{DoxyParamCaption})}



Prepare A\+H\+RS to receive data. 

Assumes uart N\+U\+S\+A\+RT will be used and connected with the ahrs I\+E\+A-\/232 interface via a ttl$<$-\/$>$I\+E\+A-\/232 converter.

Per the T\+R\+AX P\+NI user manual\+: Start Bits\+: 1 Number of Data Bits\+: 8 Stop Bits\+: 1 Parity\+: none Baud\+: B\+A\+UD


\begin{DoxyParams}{Parameters}
{\em path} & Path to A\+H\+RS from main computer, unused at the moment. \\
\hline
\end{DoxyParams}
\mbox{\Hypertarget{io__ahrs__avr_8c_afa79bf757710a1cad094f1e15eb634b7}\label{io__ahrs__avr_8c_afa79bf757710a1cad094f1e15eb634b7}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs\+\_\+recv\+\_\+start@{io\+\_\+ahrs\+\_\+recv\+\_\+start}}
\index{io\+\_\+ahrs\+\_\+recv\+\_\+start@{io\+\_\+ahrs\+\_\+recv\+\_\+start}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs\+\_\+recv\+\_\+start()}{io\_ahrs\_recv\_start()}}
{\footnotesize\ttfamily int io\+\_\+ahrs\+\_\+recv\+\_\+start (\begin{DoxyParamCaption}\item[{int($\ast$)()}]{handler }\end{DoxyParamCaption})}



Tells A\+H\+RS to start receiving attitude data. 


\begin{DoxyParams}{Parameters}
{\em handler} & Function that handles data received from A\+H\+RS. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
0 on success 
\end{DoxyReturn}
\mbox{\Hypertarget{io__ahrs__avr_8c_a2ee2459ddd2dca694bef3e6fb9b1cd54}\label{io__ahrs__avr_8c_a2ee2459ddd2dca694bef3e6fb9b1cd54}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs\+\_\+recv\+\_\+stop@{io\+\_\+ahrs\+\_\+recv\+\_\+stop}}
\index{io\+\_\+ahrs\+\_\+recv\+\_\+stop@{io\+\_\+ahrs\+\_\+recv\+\_\+stop}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs\+\_\+recv\+\_\+stop()}{io\_ahrs\_recv\_stop()}}
{\footnotesize\ttfamily void io\+\_\+ahrs\+\_\+recv\+\_\+stop (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Tells A\+H\+RS to start receiving attitude data. 

\begin{DoxyReturn}{Returns}
0 on success 
\end{DoxyReturn}
\mbox{\Hypertarget{io__ahrs__avr_8c_ac133fdc94162c623c5325f907ade9e4a}\label{io__ahrs__avr_8c_ac133fdc94162c623c5325f907ade9e4a}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer@{io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer}}
\index{io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer@{io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer()}{io\_ahrs\_tripbuf\_offer()}}
{\footnotesize\ttfamily void io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Allows tripbuf to be updated again. (Might need Seth\textquotesingle{}s confirmation) 

Makes the current write index available to io\+\_\+ahrs\+\_\+tripbuf\+\_\+update, and changes the value returned by io\+\_\+ahrs\+\_\+tripbuf\+\_\+write.

May interrupt io\+\_\+ahrs\+\_\+tripbuf\+\_\+update, but may not be interrupted by it. \mbox{\Hypertarget{io__ahrs__avr_8c_a7e158c735ff3b4a8b84cd5bd552c4954}\label{io__ahrs__avr_8c_a7e158c735ff3b4a8b84cd5bd552c4954}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs\+\_\+tripbuf\+\_\+read@{io\+\_\+ahrs\+\_\+tripbuf\+\_\+read}}
\index{io\+\_\+ahrs\+\_\+tripbuf\+\_\+read@{io\+\_\+ahrs\+\_\+tripbuf\+\_\+read}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs\+\_\+tripbuf\+\_\+read()}{io\_ahrs\_tripbuf\_read()}}
{\footnotesize\ttfamily unsigned char io\+\_\+ahrs\+\_\+tripbuf\+\_\+read (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Finds tripbuf index to read from. 

\begin{DoxyReturn}{Returns}
The index of the buffer the data consumer should read from. Only changes if io\+\_\+ahrs\+\_\+tripbuf\+\_\+update is called and returns true. 
\end{DoxyReturn}
\mbox{\Hypertarget{io__ahrs__avr_8c_a7b33a09e7c9290bcdeebf2602a54ee3d}\label{io__ahrs__avr_8c_a7b33a09e7c9290bcdeebf2602a54ee3d}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs\+\_\+tripbuf\+\_\+update@{io\+\_\+ahrs\+\_\+tripbuf\+\_\+update}}
\index{io\+\_\+ahrs\+\_\+tripbuf\+\_\+update@{io\+\_\+ahrs\+\_\+tripbuf\+\_\+update}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs\+\_\+tripbuf\+\_\+update()}{io\_ahrs\_tripbuf\_update()}}
{\footnotesize\ttfamily bool io\+\_\+ahrs\+\_\+tripbuf\+\_\+update (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Updates tripbuf with new data. 

Causes io\+\_\+ahrs\+\_\+tripbuf\+\_\+read to return index that was most recently \textquotesingle{}submitted\textquotesingle{} by io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer.

This should only be run between complete \textquotesingle{}uses\textquotesingle{} of the data, to avoid using disparate data.

Unfortunately, since there is no way to have a lock-\/free/interruptable triple buffer implementation on the avr, this has to be platform-\/specific. A lock-\/free ring buffer would not handle cases when the producer is faster than the consumer well.

May be interrupted by io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer, but cannot interrupt it (ie this can be interrupted by handler\+\_\+ahrs\+\_\+recv, but one probably does not want to call it from handler\+\_\+ahrs\+\_\+recv).

\begin{DoxyReturn}{Returns}
Whether there has been new data since last call. 
\end{DoxyReturn}
\mbox{\Hypertarget{io__ahrs__avr_8c_a7690920caf5d41a90442ca049336778c}\label{io__ahrs__avr_8c_a7690920caf5d41a90442ca049336778c}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs\+\_\+tripbuf\+\_\+write@{io\+\_\+ahrs\+\_\+tripbuf\+\_\+write}}
\index{io\+\_\+ahrs\+\_\+tripbuf\+\_\+write@{io\+\_\+ahrs\+\_\+tripbuf\+\_\+write}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs\+\_\+tripbuf\+\_\+write()}{io\_ahrs\_tripbuf\_write()}}
{\footnotesize\ttfamily unsigned char io\+\_\+ahrs\+\_\+tripbuf\+\_\+write (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})}



Finds tripbuf index to write to. 

\begin{DoxyReturn}{Returns}
The index of the buffer the data producer should write to. Only changes when io\+\_\+ahrs\+\_\+tripbuf\+\_\+offer is called. 
\end{DoxyReturn}
\mbox{\Hypertarget{io__ahrs__avr_8c_a41000847b03ed4695d02308472ac32e7}\label{io__ahrs__avr_8c_a41000847b03ed4695d02308472ac32e7}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!I\+SR@{I\+SR}}
\index{I\+SR@{I\+SR}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{I\+S\+R()}{ISR()}}
{\footnotesize\ttfamily I\+SR (\begin{DoxyParamCaption}\item[{\hyperlink{io__m5__avr_8c_ad886765314d53f6e8cb3eeaac5bffda8}{C\+C\+\_\+\+X\+XX}(U\+S\+A\+RT, \hyperlink{io__m5__avr_8c_a45719155cbf4258c29211c2f5db49b9b}{N\+U\+S\+A\+RT}, \+\_\+\+R\+X\+\_\+vect)}]{ }\end{DoxyParamCaption})}



\subsection{Variable Documentation}
\mbox{\Hypertarget{io__ahrs__avr_8c_a9268369c511d1843e8ca6846fdc87c19}\label{io__ahrs__avr_8c_a9268369c511d1843e8ca6846fdc87c19}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!clean@{clean}}
\index{clean@{clean}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{clean}{clean}}
{\footnotesize\ttfamily volatile unsigned char clean}

\mbox{\Hypertarget{io__ahrs__avr_8c_a7c946296e6bffe77d1c08cdcbd4def85}\label{io__ahrs__avr_8c_a7c946296e6bffe77d1c08cdcbd4def85}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!io\+\_\+ahrs@{io\+\_\+ahrs}}
\index{io\+\_\+ahrs@{io\+\_\+ahrs}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{io\+\_\+ahrs}{io\_ahrs}}
{\footnotesize\ttfamily F\+I\+LE$\ast$ io\+\_\+ahrs}

{\bfseries Initial value\+:}
\begin{DoxyCode}
= &(FILE)FDEV\_SETUP\_STREAM(uart\_ahrs\_putchar, uart\_ahrs\_getchar,
        \_FDEV\_SETUP\_RW)
\end{DoxyCode}


Handles IO to A\+H\+RS using file streams. 

IO with this is blocking, so one might use normal stdio functions directly on it when they are willing to wait, eg sending initial configuration data, but to be able to handle asynchronous io, one should use io\+\_\+ahrs\+\_\+...\+\_\+start, which allows us to process data on the fly and avoid polling. \mbox{\Hypertarget{io__ahrs__avr_8c_aeabde82deeb112876f1360a7999bb7ff}\label{io__ahrs__avr_8c_aeabde82deeb112876f1360a7999bb7ff}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!new@{new}}
\index{new@{new}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{new}{new}}
{\footnotesize\ttfamily volatile unsigned char new}

\mbox{\Hypertarget{io__ahrs__avr_8c_ab5ab23f12f203c3d4823a0746b033bc0}\label{io__ahrs__avr_8c_ab5ab23f12f203c3d4823a0746b033bc0}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!read@{read}}
\index{read@{read}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{read}{read}}
{\footnotesize\ttfamily unsigned char read}

\mbox{\Hypertarget{io__ahrs__avr_8c_a1c2cd2c01f90d3bf5e20b7ae1319c6d8}\label{io__ahrs__avr_8c_a1c2cd2c01f90d3bf5e20b7ae1319c6d8}} 
\index{io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}!write@{write}}
\index{write@{write}!io\+\_\+ahrs\+\_\+avr.\+c@{io\+\_\+ahrs\+\_\+avr.\+c}}
\subsubsection{\texorpdfstring{write}{write}}
{\footnotesize\ttfamily unsigned char write}

